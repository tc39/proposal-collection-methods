<!DOCTYPE html>
<emu-note type="editor">
  TODO: how to handle duplicate keys? Obvious way is to use `Map.prototype.set` through `Map` constructor, but that would break convention set by `Map.groupBy`.
</emu-note>

<emu-alg>
  1. Let _M_ be the *this* value.
  1. Perform ? RequireInternalSlot(_M_, [[MapData]]).
  1. If IsCallable(_callbackfn_) is **false**, throw a *TypeError* exception.
  1. Let _result_ be ! Construct(%Map%).
  1. Let _resultKeys_ be a new empty List.
  1. For each Record { [[Key]], [[Value]] } _e_ of _M_.[[MapData]], do
    1. If _e_.[[Key]] is not ~empty~, then
      1. Let _newKey_ be CanonicalizeKeyedCollectionKey(? Call(_callbackfn_, _T_, « _e_.[[Value]], _e_.[[Key]], _map_ »))
      1. Let _p_ be the Record { [[Key]]: _newKey_, [[Value]]: _e_.[[Value]] }
      1. If _newKey_ is present in _resultKeys_, throw **RangeError**
      1. Append _p_ to _result_.[[MapData]]
      1. Append _newKey_ to _resultKeys_
  1. Return _result_.
</emu-alg>
